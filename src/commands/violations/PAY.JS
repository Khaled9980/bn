const { EmbedBuilder, ActionRowBuilder, StringSelectMenuBuilder } = require('discord.js');
const { loadDB, saveDB, getUser } = require('../../utils/database.js');

module.exports = {
  name: 'ØªØ³Ø¯ÙŠØ¯',
  description: 'ØªØ³Ø¯ÙŠØ¯ Ù…Ø®Ø§Ù„ÙØ©',

  async execute(message) {
    try {
      const userId = message.author.id;
      const db = loadDB();
      const user = getUser(db, userId);

      if (!user.violations || user.violations.length === 0)
        return message.reply('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ Ù…Ø®Ø§Ù„ÙØ§Øª Ù„ØªØ³Ø¯ÙŠØ¯Ù‡Ø§.');

      const options = user.violations.map((v, i) => ({
        label: v.type,
        description: `Ø§Ù„ØºØ±Ø§Ù…Ø©: ${v.fine}`,
        value: i.toString()
      }));

      const menu = new StringSelectMenuBuilder()
        .setCustomId(`payviolations_${userId}`)
        .setPlaceholder('Ø§Ø®ØªØ± Ù…Ø®Ø§Ù„ÙØ© Ù„ØªØ³Ø¯ÙŠØ¯Ù‡Ø§')
        .addOptions(options);

      const row = new ActionRowBuilder().addComponents(menu);

      await message.reply({
        content: 'ğŸ’³ Ø§Ø®ØªØ± Ù…Ø®Ø§Ù„ÙØ© Ù„ØªØ³Ø¯ÙŠØ¯Ù‡Ø§:',
        components: [row]
      });
    } catch (err) {
      console.error('Execute Command Error:', err);
      message.reply('âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø¯Ø§Ø®Ù„ÙŠ Ø£Ø«Ù†Ø§Ø¡ ØªÙ†ÙÙŠØ° Ø§Ù„Ø£Ù…Ø±');
    }
  },

  async onSelect(interaction) {
    try {
      if (!interaction.isStringSelectMenu()) return;
      await interaction.deferUpdate();

      const userId = interaction.customId.split('_')[1];
      if (interaction.user.id !== userId) {
        return interaction.followUp({ content: 'âŒ Ù‡Ø°Ø§ Ù„ÙŠØ³ Ø­Ø³Ø§Ø¨Ùƒ', ephemeral: true });
      }

      const db = loadDB();
      const user = getUser(db, userId);
      const index = parseInt(interaction.values[0]);
      const v = user.violations[index];
      if (!v) return interaction.followUp({ content: 'âŒ Ù…Ø®Ø§Ù„ÙØ© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©', ephemeral: true });

      // Ø®ØµÙ… Ù…Ù† Ø§Ù„Ø¨Ù†Ùƒ ÙÙ‚Ø·
      if (user.bank < v.fine) {
        return interaction.followUp({ content: 'âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±ØµÙŠØ¯ ÙƒØ§ÙÙŠ ÙÙŠ Ø§Ù„Ø¨Ù†Ùƒ Ù„Ù„ØªØ³Ø¯ÙŠØ¯', ephemeral: true });
      }
      user.bank -= v.fine;
      user.violations.splice(index, 1);
      saveDB(db);

      const embed = new EmbedBuilder()
        .setTitle('ØªÙ… ØªØ³Ø¯ÙŠØ¯ Ù…Ø®Ø§Ù„ÙØ©')
        .setColor('Green')
        .addFields(
          { name: 'Ø§Ù„Ù…Ø®Ø§Ù„Ù', value: `<@${userId}>`, inline: true },
          { name: 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©', value: v.type, inline: true },
          { name: 'Ø§Ù„ØºØ±Ø§Ù…Ø©', value: `${v.fine}`, inline: true },
          { name: 'Ø§Ù„ØªØ§Ø±ÙŠØ®', value: `<t:${Math.floor(Date.now() / 1000)}:f>`, inline: false }
        )
        .setFooter({ text: ' ÙˆØ²Ø§Ø±Ù‡ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©' });

      const disabledMenu = new StringSelectMenuBuilder()
        .setCustomId('disabled')
        .setPlaceholder('ØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø®Ø§Ù„ÙØ©')
        .setDisabled(true)
        .addOptions([{ label: v.type, value: 'done' }]);

      const row = new ActionRowBuilder().addComponents(disabledMenu);

      await interaction.editReply({ embeds: [embed], components: [row] });
    } catch (err) {
      console.error('âš ï¸ Error in onSelect:', err);
      if (!interaction.replied && !interaction.deferred) {
        await interaction.reply({
          content: `âŒ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¯ÙŠØ¯: ${err.message}`,
          ephemeral: true
        });
      }
    }
  }
};
